Bootstrap: docker
From: hub.opensciencegrid.org/htc/ubuntu:22.04

%files
    requirements.txt requirements.txt

%post
    set -e

    # -----------------------
    # system packages
    # -----------------------
    apt-get update -y
    apt-get install -y \
        build-essential \
        wget \
        ca-certificates

    rm -rf /var/lib/apt/lists/*

    # -----------------------
    # install Miniconda
    # -----------------------
    wget -q https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda
    rm Miniconda3-latest-Linux-x86_64.sh

    #. /opt/conda/etc/profile.d/conda.sh

    # -----------------------
    # create environment from requirements.txt
    # -----------------------
    export PATH="/opt/conda/bin:$PATH"

    CONDA_NO_PLUGINS=true conda install -y --solver=classic python=3.10
    python -m pip install --upgrade pip setuptools wheel
    python -m pip install --no-cache-dir -r requirements.txt


    # optional but recommended cleanup
    rm -f requirements.txt

%environment
    export PATH="/opt/conda/bin:$PATH"

%runscript
    exec "$@"
